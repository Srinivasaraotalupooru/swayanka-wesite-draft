@page "/profile"
@using Swayanka.BlazorClient.Components.UI
@inject NavigationManager Navigation
@inject HttpClient Http

<div class="min-h-screen pt-24 px-4 bg-gray-50 pb-12">
    <div class="max-w-4xl mx-auto">

        @* Identity Card *@
        <div class="bg-white rounded-3xl p-8 shadow-sm border border-gray-100 mb-8 flex flex-col md:flex-row items-center md:items-start gap-8">
            <div class="w-24 h-24 rounded-full bg-purple-100 flex items-center justify-center text-purple-600 text-3xl font-bold border-4 border-white shadow-lg overflow-hidden">
                <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
            </div>
            <div class="flex-1 text-center md:text-left">
                @if (AuthService.IsAuthenticated)
                {
                    <h2 class="text-3xl font-bold text-gray-900">Swayanka Member</h2>
                    <p class="text-gray-500 mb-4">member@example.com</p>
                    <div class="flex gap-4 justify-center md:justify-start">
                        <button class="flex items-center gap-2 px-4 py-2 bg-purple-50 text-purple-700 rounded-lg text-sm font-medium">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10"/><path d="m9 12 2 2 4-4"/></svg> Verified Account
                        </button>
                        <button @onclick="Logout" class="flex items-center gap-2 px-4 py-2 border border-gray-200 text-gray-600 rounded-lg text-sm hover:bg-gray-50 hover:text-red-600 transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" x2="9" y1="12" y2="12"/></svg> Sign Out
                        </button>
                    </div>
                }
                else
                {
                    <h2 class="text-3xl font-bold text-gray-900">Guest User</h2>
                    <p class="text-gray-500 mb-6 max-w-md">Sign in to track your orders and save your preferences.</p>
                    <div class="flex justify-center md:justify-start">
                        <Button OnClick="Login" Variant="google">Sign in with Google (Demo)</Button>
                    </div>
                }
            </div>
        </div>

        @* Order History *@
        @if (AuthService.IsAuthenticated)
        {
            <div class="bg-white rounded-3xl p-8 shadow-sm border border-gray-100">
                <h3 class="text-xl font-bold text-gray-900 mb-6 flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-purple-600"><path d="m7.5 4.27 9 5.15"/><path d="M21 8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16Z"/><path d="m3.3 7 8.7 5 8.7-5"/><path d="M12 22V12"/></svg> Order History
                </h3>

                @if (orders.Count == 0)
                {
                    <div class="text-center py-12 bg-gray-50 rounded-2xl border border-dashed border-gray-200">
                        <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mx-auto text-gray-300 mb-3"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
                        <p class="text-gray-500">No orders yet.</p>
                    </div>
                }
                else
                {
                    <div class="space-y-6">
                        @foreach (var order in orders)
                        {
                            <div class="border border-gray-100 rounded-2xl p-6 hover:shadow-md transition-shadow">
                                <div class="flex flex-col md:flex-row justify-between mb-4 pb-4 border-b border-gray-50">
                                    <div>
                                        <span class="text-sm text-gray-500 block">Order @order.OrderNumber</span>
                                        <span class="font-medium text-gray-900">@order.CreatedAt.ToShortDateString()</span>
                                    </div>
                                    <div class="mt-2 md:mt-0 flex items-center gap-2">
                                        <span class="px-3 py-1 bg-green-100 text-green-700 rounded-full text-xs font-bold uppercase">
                                            @order.Status
                                        </span>
                                        <span class="font-bold text-lg">â‚¹@order.TotalAmount</span>
                                    </div>
                                </div>
                                <div class="flex gap-4 overflow-x-auto pb-2">
                                    @foreach (var item in order.Items)
                                    {
                                        <div class="w-16 h-16 bg-gray-50 rounded-lg p-1 flex-shrink-0" title="@item.ProductName">
                                            <GarmentSVG Type="@item.Category" Color="@item.ColorHex" Class="w-full h-full" />
                                        </div>
                                    }
                                </div>
                            </div>
                        }
                    </div>
                }
            </div>
        }
    </div>
</div>

@code {
    [Inject] public Swayanka.BlazorClient.Services.AuthService AuthService { get; set; } = default!;
    private List<OrderDto> orders = new();
    private string userId = "guest-user";

    protected override async Task OnInitializedAsync()
    {
        AuthService.OnChange += StateHasChanged;
        if (AuthService.IsAuthenticated)
        {
            await LoadOrders();
        }
    }

    public void Dispose()
    {
        AuthService.OnChange -= StateHasChanged;
    }

    private async Task Login()
    {
        AuthService.Login();
        await LoadOrders();
    }

    private void Logout()
    {
        AuthService.Logout();
        orders.Clear();
    }

    private async Task LoadOrders()
    {
        try
        {
            orders = await Http.GetFromJsonAsync<List<OrderDto>>($"api/orders/{userId}") ?? new();
        }
        catch
        {
            orders = new();
        }
    }

    public class OrderDto
    {
        public Guid Id { get; set; }
        public string OrderNumber { get; set; } = "";
        public decimal TotalAmount { get; set; }
        public string Status { get; set; } = "";
        public DateTime CreatedAt { get; set; }
        public List<OrderItemDto> Items { get; set; } = new();
    }

    public class OrderItemDto
    {
        public string ProductName { get; set; } = "";
        public string Category { get; set; } = "";
        public string ColorHex { get; set; } = "";
    }
}
