@page "/cart"
@using Swayanka.BlazorClient.Components.UI
@inject NavigationManager Navigation
@inject HttpClient Http

@if (cart == null)
{
    <div class="min-h-screen pt-24 flex justify-center">Loading...</div>
}
else
{
    <div class="min-h-screen pt-24 px-4 bg-gray-50">
        <div class="max-w-2xl mx-auto">
            <h2 class="text-3xl font-bold mb-8">Your Collection</h2>
            @if (cart.Items.Count == 0)
            {
                <div class="text-center py-20">
                    <p class="text-gray-400">Your story is empty.</p>
                    <Button Class="mt-4" OnClick="@(() => Navigation.NavigateTo("/"))">Begin</Button>
                </div>
            }
            else
            {
                <div class="space-y-4">
                    @for (int i = 0; i < cart.Items.Count; i++)
                    {
                        var item = cart.Items[i];
                        var index = i;
                        <div class="bg-white p-6 rounded-2xl shadow-sm flex items-center gap-6">
                            <div class="w-20 h-20 bg-gray-50 rounded-xl p-2">
                                <GarmentSVG Type="@item.Category" Color="@item.ColorHex" Class="w-full h-full" />
                            </div>
                            <div class="flex-1">
                                <h3 class="font-bold text-lg">@item.ProductName</h3>
                                <p class="text-sm text-gray-500">@item.Size</p>
                                <p class="text-sm font-semibold mt-1">₹@item.UnitPrice</p>
                            </div>
                            <button @onclick="@(() => HandleRemove(index))" class="text-gray-300 hover:text-red-500">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg>
                            </button>
                        </div>
                    }
                    <div class="mt-8 border-t border-gray-200 pt-8">
                        <div class="flex justify-between text-xl font-bold mb-8">
                            <span>Total</span>
                            <span>₹@cart.Items.Sum(i => i.UnitPrice)</span>
                        </div>
                        <Button Class="w-full" OnClick="HandleCheckout">Checkout</Button>
                    </div>
                </div>
            }
        </div>
    </div>
}

@code {
    private CartDto? cart;
    private string userId = "guest-user"; // Hardcoded for now

    protected override async Task OnInitializedAsync()
    {
        await LoadCart();
    }

    private async Task LoadCart()
    {
        try
        {
            cart = await Http.GetFromJsonAsync<CartDto>($"api/cart/{userId}");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading cart: {ex.Message}");
            // Handle error (e.g., cart not found for new user)
            cart = new CartDto();
        }
    }

    private async Task HandleRemove(int index)
    {
        await Http.DeleteAsync($"api/cart/{userId}/items/{index}");
        await LoadCart();
    }

    private async Task HandleCheckout()
    {
        if (cart == null || cart.Items.Count == 0) return;

        var total = cart.Items.Sum(i => i.UnitPrice);
        var order = new
        {
            UserId = userId,
            OrderNumber = $"ORD-{new Random().Next(10000, 99999)}",
            TotalAmount = total,
            Status = "Processing",
            Items = cart.Items
        };

        await Http.PostAsJsonAsync("api/orders", order);
        await Http.DeleteAsync($"api/cart/{userId}");
        
        // Alert not supported directly
        Console.WriteLine("Order placed successfully!");
        Navigation.NavigateTo("/profile");
    }

    public class CartDto
    {
        public List<CartItemDto> Items { get; set; } = new();
    }

    public class CartItemDto
    {
        public string ProductName { get; set; } = "";
        public string Category { get; set; } = "";
        public string ColorHex { get; set; } = "";
        public string Size { get; set; } = "";
        public decimal UnitPrice { get; set; }
    }
}
